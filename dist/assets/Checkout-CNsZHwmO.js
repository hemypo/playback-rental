import{Q as Y,E as F,F as ee,j as e,a as S,T as D,U as I,V as E,W as q,I as Q,b as M,G as te,e as se,Y as k,M as ae,Z as ne,r as g,K as re,f as R,_ as T,a0 as H,a1 as A,a2 as P,a3 as le,L as K,A as ie,B as ce,a4 as oe,a5 as de,a6 as b,a7 as ue,a8 as me,a9 as L,aa as he}from"./index-CKzDOQbx.js";import{u as xe,i as B,g as pe,s as ge}from"./telegramService-CW-3MxVF.js";import{f as O,S as fe}from"./separator-B5PMj3PH.js";import{Q as je}from"./QuantitySelector-_QMh9DO_.js";import{T as ve}from"./trash-TJGOcr98.js";import"./serverApi-CMjEJksR.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ye=Y("ShieldCheck",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]),Ne=()=>{const{cartItems:r,removeFromCart:m,updateItemQuantity:v}=F(),f=[...new Set(r.map(a=>a.productId))],{data:s={}}=ee({queryKey:["cart-products",f],queryFn:async()=>(await Promise.all(f.map(async i=>{const[c,l]=await Promise.all([ae(i),ne(i)]);return{productId:i,product:c,bookings:l}}))).reduce((i,{productId:c,product:l,bookings:j})=>(i[c]={product:l,bookings:j},i),{}),enabled:f.length>0,staleTime:30*1e3,refetchInterval:60*1e3});return r.length===0?e.jsxs(S,{className:"mb-8",children:[e.jsxs(D,{children:[e.jsx(I,{children:"Ваша корзина"}),e.jsx(E,{children:"Проверьте ваш заказ перед оформлением"})]}),e.jsx(q,{children:e.jsxs("div",{className:"text-center py-10",children:[e.jsx("svg",{className:"mx-auto h-12 w-12 text-muted-foreground mb-4",width:"2em",height:"2em",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M12 2a6 6 0 0 0-6 6v2H4a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2h-2V8a6 6 0 0 0-6-6zM6 8a6 6 0 0 1 12 0v2H6V8zm14 10H4v-8h16v8zm-2 2H6v-2h12v2zm2-2V8V6a8 8 0 1 0-16 0v2H2a4 4 0 0 0-4 4v8a4 4 0 0 0 4 4h16a4 4 0 0 0 4-4z"})}),e.jsx("h3",{className:"text-xl font-medium mb-2",children:"Ваша корзина пуста"}),e.jsx("p",{className:"text-muted-foreground mb-6",children:"Похоже, вы еще не добавили какое-либо оборудование в свою корзину."}),e.jsx(Q,{asChild:!0,children:e.jsx("a",{href:"/catalog",children:"Просмотр каталога"})})]})})]}):e.jsxs(S,{className:"mb-8",children:[e.jsxs(D,{children:[e.jsx(I,{children:"Ваша корзина"}),e.jsx(E,{children:"Проверьте ваш заказ перед оформлением"})]}),e.jsx(q,{children:e.jsx("div",{className:"space-y-6",children:r.map(a=>{const i=Math.ceil((a.endDate.getTime()-a.startDate.getTime())/36e5),c=M(a.price,i),l=c.total*a.quantity,j=s[a.productId],u=j?te(j.product,j.bookings,a.startDate,a.endDate):a.quantity;return e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"w-24 h-24 rounded-lg overflow-hidden flex-shrink-0 subtle-ring",children:e.jsx("img",{src:a.imageUrl,alt:a.title,className:"w-full h-full object-cover"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-medium mb-1",children:a.title}),e.jsxs("p",{className:"text-sm text-muted-foreground mb-2",children:[e.jsx(se,{className:"inline-block h-3 w-3 mr-1"}),O(a.startDate,a.endDate,!0)]}),c.dayDiscount>0&&e.jsxs("p",{className:"text-xs text-green-600 mb-1",children:["Скидка: ",c.dayDiscount,"%"]}),a.quantity>u&&e.jsxs("p",{className:"text-xs text-red-600 mb-1",children:["⚠️ Доступно только ",u," шт. на выбранные даты"]}),e.jsx("div",{className:"mb-3",children:e.jsx(je,{quantity:a.quantity,onQuantityChange:o=>v(a.id,o),maxQuantity:Math.max(1,u),size:"sm"})}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[c.discount>0?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-sm line-through text-muted-foreground",children:k(c.subtotal*a.quantity)}),e.jsx("p",{className:"font-medium",children:k(l)})]}):e.jsx("p",{className:"font-medium",children:k(l)}),a.quantity>1&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:[k(c.total)," × ",a.quantity]})]}),e.jsx(Q,{variant:"ghost",size:"sm",className:"h-8 text-muted-foreground hover:text-destructive",onClick:()=>m(a.id),children:e.jsx(ve,{className:"h-4 w-4"})})]})]})]},a.id)})})})]})},Ce=({initialStartDate:r,initialEndDate:m,onBookingChange:v,selectedBookingTime:f,onClose:s})=>{const[a,i]=g.useState(null),c=g.useCallback(j=>{const u=`${j.startDate.getTime()}-${j.endDate.getTime()}`;u!==a&&(i(u),v(j),s&&s())},[a,v,s]),l=g.useCallback(()=>{s&&s()},[s]);return!r||!m?null:e.jsxs(S,{className:"mb-8",children:[e.jsxs(D,{children:[e.jsx(I,{children:"Редактировать время аренды"}),e.jsx(E,{children:"Вы можете изменить время аренды если нужно"})]}),e.jsxs(q,{children:[e.jsx(re,{onBookingChange:c,initialStartDate:r,initialEndDate:m,isCompact:!1,onClose:l}),f&&e.jsx("div",{className:"mt-4 p-3 bg-primary/10 rounded-md",children:e.jsxs("p",{className:"text-sm font-medium flex items-center",children:[e.jsx(R,{className:"h-4 w-4 mr-2"}),"Выбранное новое время аренды: ",O(f.startDate,f.endDate,!0)]})})]})]})},_=/^[A-Za-zА-Яа-яЁё\s\-]+$/,X=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,be=({formData:r,onInputChange:m})=>{const{handlePhoneChange:v,handlePhonePaste:f}=xe(h=>{m({target:{name:"phone",value:h}})}),[s,a]=g.useState({}),[i,c]=g.useState(!1),[l,j]=g.useState(!1);g.useEffect(()=>{l&&(o("name",r.name),o("email",r.email),o("phone",r.phone)),l&&r.name&&r.email&&B(r.phone)&&_.test(r.name)&&X.test(r.email)&&c(!1)},[r,l]),g.useEffect(()=>{const h=x=>{var N,C;const p=x.target;p.closest("button")&&((C=(N=p.closest("button"))==null?void 0:N.textContent)!=null&&C.includes("Оформить заказ"))&&(j(!0),u()||c(!0))};return document.addEventListener("click",h),()=>{document.removeEventListener("click",h)}},[r]);const u=()=>{const h=o("name",r.name),x=o("email",r.email),p=o("phone",r.phone);return h&&x&&p},o=(h,x)=>{let p="",N=!0;return x.trim()?h==="name"?_.test(x.trim())||(p="Имя может содержать только буквы, пробелы и дефисы",N=!1):h==="email"?X.test(x.trim())||(p="Введите корректный email",N=!1):h==="phone"&&(B(x)||(p=pe(),N=!1)):(p="Поле обязательно для заполнения",N=!1),a(C=>({...C,[h]:p})),N},y=h=>{const{name:x,value:p}=h.target;l&&o(x,p)};return e.jsxs(S,{children:[e.jsxs(D,{children:[e.jsx(I,{children:"Детали аренды"}),e.jsx(E,{children:"Заполните информацию о вашем бронировании"})]}),e.jsxs(q,{children:[i&&e.jsxs(T,{variant:"destructive",className:"mb-4",children:[e.jsx(H,{className:"h-4 w-4"}),e.jsx(A,{children:"Пожалуйста, заполните все обязательные поля корректно перед оформлением заказа"})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium",htmlFor:"name",children:["Имя ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(P,{id:"name",name:"name",value:r.name,onChange:m,placeholder:"Иван Иванов",onBlur:y,className:l&&s.name?"border-destructive":"",autoComplete:"off",pattern:"[A-Za-zА-Яа-яЁё\\s\\-]+",required:!0}),l&&s.name&&e.jsx("span",{className:"text-destructive text-sm",children:s.name})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium",htmlFor:"email",children:["E-mail ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(P,{type:"email",id:"email",name:"email",value:r.email,onChange:m,placeholder:"email@example.com",onBlur:y,className:l&&s.email?"border-destructive":"",autoComplete:"off",pattern:"^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$",required:!0}),l&&s.email&&e.jsx("span",{className:"text-destructive text-sm",children:s.email})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium",htmlFor:"phone",children:["Телефон ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(P,{type:"tel",id:"phone",name:"phone",value:r.phone,onChange:v,onPaste:f,placeholder:"+7 (___) ___-__-__",onBlur:y,className:l&&s.phone?"border-destructive":"",autoComplete:"off",maxLength:18,required:!0}),l&&s.phone&&e.jsx("span",{className:"text-destructive text-sm",children:s.phone})]})]})]})]})},we=({onCheckout:r,loading:m})=>{const{cartItems:v,getCartTotal:f}=F();return e.jsxs(S,{className:"sticky top-20",children:[e.jsx(D,{children:e.jsx(I,{children:"Ваш заказ"})}),e.jsxs(q,{className:"space-y-4",children:[v.map(s=>{const a=Math.ceil((s.endDate.getTime()-s.startDate.getTime())/36e5),i=M(s.price,a);return e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:s.title}),e.jsx("span",{children:k(i.total)})]}),i.dayDiscount>0&&e.jsxs("div",{className:"flex justify-between text-xs text-green-600",children:[e.jsx("span",{children:"Скидка:"}),e.jsxs("span",{children:["-",i.dayDiscount,"%"]})]})]},s.id)}),e.jsx(fe,{}),e.jsxs("div",{className:"flex justify-between text-lg font-semibold",children:[e.jsx("span",{children:"Итого:"}),e.jsx("span",{children:k(f())})]})]}),e.jsx(le,{children:e.jsx(Q,{className:"w-full",size:"lg",onClick:r,disabled:m||v.length===0,children:m?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}),"Отправка..."]}):"Подтвердить бронирование"})})]})},ke=()=>e.jsxs("div",{className:"container mx-auto px-4 py-16 flex flex-col items-center justify-center min-h-[70vh]",children:[e.jsx("div",{className:"w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-6",children:e.jsx(ye,{className:"h-10 w-10 text-green-600"})}),e.jsx("h1",{className:"heading-2 mb-4 text-center",children:"Бронирование подтверждено!"}),e.jsx("p",{className:"text-xl text-center text-muted-foreground mb-8 max-w-md",children:"Ваш прокат оборудования подтвержден. Наш менеджер свяжется с вами в ближайшее время!"}),e.jsx("div",{className:"flex flex-col sm:flex-row gap-4",children:e.jsx(Q,{asChild:!0,size:"lg",children:e.jsx(K,{to:"/catalog",children:"Вернуться к каталогу"})})})]}),Pe=()=>{var V,$;const[r,m]=g.useState(!1),[v,f]=g.useState(!1),[s,a]=g.useState({name:"",email:"",phone:""}),[i,c]=g.useState([]),[l,j]=g.useState(null),[u,o]=g.useState({status:"idle"}),{cartItems:y,removeFromCart:h,getCartTotal:x,clearCart:p,updateCartDates:N}=F();ie(),ce();const C=oe(),z=n=>{const{name:t,value:d}=n.target;a(w=>({...w,[t]:d}))},Z=n=>{j(n),n&&n.startDate&&n.endDate&&N(n.startDate,n.endDate)},U=()=>{const n=[];return s.name.trim()||n.push("Имя не должно быть пустым"),/^[A-Za-zА-Яа-яЁё\s\-]+$/.test(s.name.trim())||n.push("Имя может содержать только буквы"),s.email.trim()||n.push("Email не должен быть пустым"),/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s.email.trim())||n.push("Введите корректный email"),B(s.phone)||n.push("Телефон должен содержать 10 цифр в формате +7 (XXX) XXX-XX-XX"),y.length===0&&n.push("Корзина пуста"),c(n),n.length===0},G=async()=>{if(!U()){b.error("Пожалуйста, заполните все поля формы корректно");return}m(!0),o({status:"sending",message:"Обрабатываем заказ..."});try{const n=new Map;y.forEach(t=>{const d=t.productId;if(n.has(d)){const w=n.get(d);w.totalQuantity+=t.quantity}else n.set(d,{productId:t.productId,title:t.title,price:t.price,startDate:t.startDate,endDate:t.endDate,totalQuantity:t.quantity})}),console.log("Creating bookings for grouped items:",{originalItems:y.length,groupedItems:n.size,groups:Array.from(n.values()).map(t=>({productId:t.productId,title:t.title,quantity:t.totalQuantity}))});for(const t of n.values()){const d=ue(t.price,t.startDate,t.endDate),w=d*t.totalQuantity;console.log("Creating booking:",{productId:t.productId,title:t.title,quantity:t.totalQuantity,rentalPrice:d,totalPrice:w}),await me({productId:t.productId,customerName:s.name,customerEmail:s.email,customerPhone:s.phone,startDate:t.startDate.toISOString(),endDate:t.endDate.toISOString(),status:"pending",totalPrice:w,quantity:t.totalQuantity,notes:`Заказ: ${t.title} (${t.totalQuantity} шт.)`})}await C.invalidateQueries({queryKey:["bookings"]}),await C.invalidateQueries({queryKey:["products"]});for(const t of n.values())await C.invalidateQueries({queryKey:["product-bookings",t.productId]});await C.invalidateQueries({queryKey:["cart-products"]}),o({status:"sending",message:"Отправляем уведомление..."});try{console.log("Sending enhanced Telegram notification for checkout...");const t=await ge({name:s.name,email:s.email,phone:s.phone,items:Array.from(n.values()).map(d=>({title:d.title,price:d.price,startDate:d.startDate.toISOString(),endDate:d.endDate.toISOString(),quantity:d.totalQuantity})),totalAmount:x()});if(t.success)o({status:"success",message:`Уведомление отправлено (${t.successfulChats}/${t.attemptedChats} получателей)`}),console.log("Enhanced Telegram notification sent successfully:",t),b.success("Уведомление отправлено!");else{const d=t.successfulChats>0;o({status:d?"partial":"failed",message:t.message,details:`Доставлено: ${t.successfulChats}/${t.attemptedChats} получателей`}),d?(console.warn("Partial notification delivery:",t),b.warning("Заказ оформлен, но не все уведомления доставлены")):(console.error("Failed to send notifications:",t),b.warning("Заказ оформлен, но уведомления не отправлены"))}}catch(t){console.error("Error sending enhanced Telegram notification:",t),o({status:"failed",message:"Ошибка отправки уведомлений",details:t instanceof Error?t.message:"Неизвестная ошибка"}),b.warning("Заказ оформлен, но произошла ошибка при отправке уведомлений")}p(),f(!0),b.success("Заказ оформлен успешно!"),console.log("Booking completed successfully:",{uniqueProducts:n.size,totalValue:x()})}catch(n){console.error("Error during checkout:",n),o({status:"failed",message:"Ошибка при оформлении заказа",details:n instanceof Error?n.message:"Неизвестная ошибка"}),b.error("Ошибка при оформлении заказа")}finally{m(!1),setTimeout(()=>{o({status:"idle"})},5e3)}},J=()=>{switch(u.status){case"sending":return e.jsx(R,{className:"h-4 w-4 animate-spin"});case"success":return e.jsx(he,{className:"h-4 w-4 text-green-600"});case"partial":return e.jsx(L,{className:"h-4 w-4 text-yellow-600"});case"failed":return e.jsx(L,{className:"h-4 w-4 text-red-600"});default:return null}},W=()=>{switch(u.status){case"success":return"default";case"partial":return"default";case"failed":return"destructive";default:return"default"}};return v?e.jsx(ke,{}):e.jsxs("div",{className:"container mx-auto px-4 py-12",children:[e.jsx("div",{className:"flex items-center mb-8",children:e.jsxs(K,{to:"/catalog",className:"flex items-center text-muted-foreground hover:text-foreground transition-colors",children:[e.jsx(de,{className:"mr-2 h-4 w-4"}),"Вернуться к каталогу"]})}),e.jsx("h1",{className:"heading-2 mb-8",children:"Корзина"}),i.length>0&&e.jsxs(T,{variant:"destructive",className:"mb-6",children:[e.jsx(H,{className:"h-4 w-4"}),e.jsxs(A,{children:[e.jsx("div",{className:"font-medium",children:"Пожалуйста, исправьте следующие ошибки:"}),e.jsx("ul",{className:"list-disc pl-5 mt-2",children:i.map((n,t)=>e.jsx("li",{children:n},t))})]})]}),u.status!=="idle"&&e.jsxs(T,{variant:W(),className:"mb-6",children:[J(),e.jsxs(A,{children:[e.jsx("div",{className:"font-medium",children:u.message}),u.details&&e.jsx("div",{className:"text-sm mt-1 opacity-90",children:u.details})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2",children:[e.jsx(Ne,{}),y.length>0&&e.jsx(Ce,{initialStartDate:(V=y[0])==null?void 0:V.startDate,initialEndDate:($=y[0])==null?void 0:$.endDate,onBookingChange:Z,selectedBookingTime:l})]}),e.jsxs("div",{children:[e.jsx(be,{formData:s,onInputChange:z}),e.jsx("div",{className:"mt-6",children:e.jsx(we,{onCheckout:G,loading:r})})]})]})]})};export{Pe as default};
